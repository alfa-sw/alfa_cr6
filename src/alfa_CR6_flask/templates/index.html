{% extends 'admin/master.html' %}

{% block body %}
  <p></p>
  
<style>
	th, td {
	  padding: 10px;
	}

	table{
	  border: 1px solid light-grey;
	  border-collapse: collapse;
	  width: 100%;
	}

	.scrollable {
	  background-color: #FFFFCC;
	  height: 300px;
	  overflow: auto;
	}

	.block_container {
		background-color: #CCF7F7;
//~ 		margin-left: 30px;
//~ 		margin-right: 30px;
	}
</style>



<div><a href="{{ alfa40_admin_url }}" target="_blank">alfa40_admin_url</a></div>
<div class="block_container">

	<form method="POST" action="/upload" enctype="multipart/form-data" id="upload_data_form">
		<table class="head_table">
		<tr>
		<td id="server_time" width="30%"></td>
		<td id="live_can_list" width="30%"></td>
		<td width="20%" title="upload formula files (.dat, .pdf, .json)">
			<label for="input_file">choose a formula file to upload<br/>(.dat, .pdf, .json)</label>
			<input class="btn btn-primary" type="file" name="file" multiple="true" autocomplete="on" required id="input_file"></input>
		</td>
		<td width="6%">
			<input class="btn btn-primary" type="submit" value="upload"><img width="32px" src="static/images/upload.png"></img></input>
		</td>
		</tr>
		</table>
	</form>
	
	<table class="status_table">

		<tr><th>A</th><th>B</th><th>C</th></tr>
		<tr>
		{% for i in (0, 2, 4) %}
		<td><div class="scrollable" id="device:machine:status_{{ i }}"> {{ i }} </div> </td>
		{% endfor %}
		</tr>

		<tr><th>F</th><th>E</th><th>D</th></tr>
		<tr>
		{% for i in (1, 3, 5) %}
		<td><div class ="scrollable" id="device:machine:status_{{ i }}"> {{ i }} </div> </td>
		{% endfor %}
		</tr>

	</table>
</div>

    </p><p>

    <label>Current Language:</label> 
	<label id="current_language_label">{{ current_language }}</label>
	-
	<b> Change Language to: </b> 
	<input class="btn btn-primary" type="submit" value="ENGLISH" onclick="change_language('en');"></input>
	<input class="btn btn-primary" type="submit" value="ITALIAN" onclick="change_language('it');"></input>
	<input class="btn btn-primary" type="submit" value="KOREAN " onclick="change_language('kr');"></input>
	<label>(WARN application will be restarted)</label>
	</p>

	<hr></hr>
	<h4 class="glyphicon glyphicon-wrench" onclick="toggle_element_visibility('manhole_commander');"></h4>
	<div title="Beware: use it only if you know what you are doing." id="manhole_commander" style="visibility: hidden;">
		<span>Manhole commander (expert usage only):</span>
		<input type="text" size="40" id="debug_command" onkeydown="if(event.keyCode === 13) {send_debug_cmd()};"></input>
		<input type="submit" onclick="send_debug_cmd();"></input>
		<span id="debug_answer"></span>
	</div>

	<div><hr></hr></div>

<script>

	var g_ws_client = null;
	
	var toggle_element_visibility = function(el_id) {
		var el = document.getElementById(el_id); 
		if(el){
			if (el.style.visibility === "hidden") {
				el.style.visibility = "visible"; 
			} else {
				el.style.visibility = "hidden"; 
			}
		}
	}
	var send_debug_cmd = function() {
		var el = document.getElementById("debug_command"); 
		if((el) && (g_ws_client)){
			el.value;
			console.debug('send_debug_cmd(), el.value: ' + el.value); 
			g_ws_client.send(JSON.stringify({"debug_command": el.value}));
		}
	}

	var change_language = function(lang_) {

		var msg_ = "Confirm changing language to " + lang_ + "? WARN: Application will be restarted.";
		if (window.confirm(msg_)) {
			console.debug('change_language(), lang_: ' + lang_); 
			var cmd = {"command": 'change_language', 'params': {'lang': lang_}};
			cmd = JSON.stringify(cmd);
			console.debug('change_language(), cmd: ' + cmd); 
			g_ws_client.send(cmd);
		};
	};

	var on_wsocket_open = function(event) {
		console.debug('on_wsocket_open, event: ' + JSON.stringify(event)); 
	};
	var on_wsocket_close =  function(event) {
		console.log('on_wsocket_close, event: ' + JSON.stringify(event)); 
	};
	var on_wsocket_error = function(event) {
		console.log('on_wsocket_error, event: ' + JSON.stringify(event));
	};
	var on_wsocket_message = function(event) {
		var data = JSON.parse(event.data);
//~ 		console.log('on_wsocket_message() data.value:', data.value)
		var data_container_id = null;
		console.log('on_wsocket_message() data.type:', data.type)
		console.log('on_wsocket_message() data.value:', data.value)
		var el = document.getElementById(data.type); 
		if(el){
			el.innerHTML = data.value;
		}
		if (data.server_time) {
			var el1 = document.getElementById('server_time'); 
			if(el1){
				el1.innerHTML = data.server_time;
			}
		}
	};

	var connect_wsocket = function(ws_server_url) {
		console.log('connect_wsocket() ws_server_url:', ws_server_url)
		if ((g_ws_client === null) || (ws_client.readyState == 3)/* CLOSED */) {
			g_ws_client = new WebSocket(ws_server_url);
			g_ws_client.onerror = on_wsocket_error; 
			g_ws_client.onopen = on_wsocket_open;  
			g_ws_client.onclose = on_wsocket_close;
			g_ws_client.onmessage = on_wsocket_message;
			// console.log(ws_server_url +" g_ws_client: ", g_ws_client);
		} else {
			if ((g_ws_client) && (g_ws_client.readyState == 1)/* OPEN */) {
				try {
				  g_ws_client.close(); 
				}
				catch(error) {
				  console.error(error);
				  g_ws_client = null;
				}
			}
		}
		console.log('connect_wsocket() g_ws_client:', g_ws_client)
	};

	connect_wsocket("ws://{{ ws_ip_addr_and_port }}/device:machine:status");

</script>

{% endblock %}
